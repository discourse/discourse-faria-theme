<script type="text/discourse-plugin" version="0.8">
  const { iconNode } = require("discourse-common/lib/icon-library");

  // Add username to header

  var h = require('virtual-dom').h;

  api.createWidget("header-username", {
     tagName: "span.header-username",
     buildKey: attrs => `header-username`,

     html(attrs, state){
       let currentUser = api.getCurrentUser();

       if (currentUser) {
         return h('span', currentUser.username)

       }
       }
  });

  api.decorateWidget('user-dropdown:after', (helper)=>{
   const showExtraInfo = helper.attrs.topic;
   if(!showExtraInfo) {
       return [helper.widget.attach('header-username')];
     }
  });

  // Custom help menu

  api.createWidget('help-menu', {
    tagName: 'div.help-panel.user-panel',

    panelContents() {
      return "Help menu contents here";
    },

    html() {
      return this.attach('menu-panel', {
        contents: () => this.panelContents()
      });
    },

    clickOutside() {
      this.sendWidgetAction('toggleHelp');
    }
  });

  api.decorateWidget('header-icons:after', function(helper) {
    const headerState = helper.widget.parentWidget.state;
    let contents = [];

      contents.push(helper.attach('header-dropdown', {
        title: 'help-menu',
        icon: 'faria-help',
        active: headerState.helpVisible,
        iconId: 'toggle-help-menu',
        action: 'toggleHelp',
      }));

      return contents;
  });

  api.addHeaderPanel('help-menu', 'helpVisible', function(attrs, state) {
           return {};
         });

  api.attachWidgetAction('header', 'toggleHelp', function() {
    this.state.helpVisible = !this.state.helpVisible;
  });
</script>

<script type="text/discourse-plugin" version="0.8">
  api.modifyClass('component:topic-navigation', {
    _performCheckSize() {
        if (!this.element || this.isDestroying || this.isDestroyed) {
          return;
        }

        let info = this.info;

        if (info.get("topicProgressExpanded")) {
          info.setProperties({
            renderTimeline: true,
            renderAdminMenuButton: true
          });
        } else {
          let renderTimeline = !this.site.mobileView;

          if (renderTimeline) {
            const width = $(window).width();
            let height = $(window).height();

            if (this.composerOpen) {
              height -= $("#reply-control").height();
            }

            renderTimeline = width > 1224 && height > 520;
          }

          info.setProperties({
            renderTimeline,
            renderAdminMenuButton: !renderTimeline
          });
        }
      },
  });
</script>
